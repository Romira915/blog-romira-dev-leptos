# 公開画面テストケース

## TC-001 トップページ: 記事一覧が新着順で表示される

| 項目 | 内容 |
|------|------|
| **機能ID** | F-001 |
| **カテゴリ** | 正常系 |

### 前提条件

- サーバーが起動している
- Newt CMS / WordPress / Qiita の各APIが正常に応答する
- `features` Cookie は未設定（通常モード）

### 手順

1. ブラウザで `http://127.0.0.1:3000/` にアクセスする

### 期待結果

- 記事カード一覧が表示される
- 各カードにサムネイル画像、タイトル、カテゴリ、投稿日が表示される
- 記事が `first_published_at` の降順（新しい順）でソートされている
- 記事ソース種別（Newt / WordPress / Qiita）に応じた記事が含まれる
- 著者プロフィール（名前、アバター、説明文）が表示される

### 備考

- 外部サービスのいずれかが失敗した場合は500エラーとなる（TC-001では正常時のみ確認）

---

## TC-002 トップページ: features=local時にDB記事が含まれる

| 項目 | 内容 |
|------|------|
| **機能ID** | F-001 |
| **カテゴリ** | 正常系 |

### 前提条件

- サーバーが起動している
- DBに公開記事（`published_articles`）が1件以上存在する
- 管理画面で `features=local` トグルをONにする、または `features=local` Cookie を手動設定

### 手順

1. `features=local` Cookie が設定された状態で `http://127.0.0.1:3000/` にアクセスする

### 期待結果

- Newt / WordPress / Qiita の記事に加えて、DBの公開記事も一覧に含まれる
- DB記事のソース種別が `Local` と表示される
- 全記事が `first_published_at` の降順でソートされている

### 備考

- DB記事取得に失敗した場合、warnログのみ出力し他ソースの記事は正常に表示される

---

## TC-003 トップページ: features=local時のキャッシュ無効化

| 項目 | 内容 |
|------|------|
| **機能ID** | F-001 |
| **カテゴリ** | 正常系 |

### 前提条件

- `features=local` Cookie が設定されている

### 手順

1. `features=local` Cookie が設定された状態で `http://127.0.0.1:3000/` にアクセスする
2. ブラウザの開発者ツール > ネットワークタブでレスポンスヘッダを確認する

### 期待結果

- `Cache-Control` ヘッダが `no-cache, must-revalidate, no-store, max-age=0, stale-while-revalidate=0, private` である
- `CDN-Cache-Control` ヘッダが `no-cache, must-revalidate, no-store, max-age=0, stale-while-revalidate=0, private` である

### 備考

- TC-401（キャッシュ制御）と重複するが、features=local固有の動作確認として独立テストケースとする

---

## TC-004 トップページ: 通常時のキャッシュヘッダ確認

| 項目 | 内容 |
|------|------|
| **機能ID** | F-001 |
| **カテゴリ** | 正常系 |

### 前提条件

- `features` Cookie は未設定（通常モード）

### 手順

1. `http://127.0.0.1:3000/` にアクセスする
2. ブラウザの開発者ツール > ネットワークタブでレスポンスヘッダを確認する

### 期待結果

- `Cache-Control` ヘッダが `no-cache, must-revalidate, max-age=10, stale-while-revalidate=1296000` である
- `CDN-Cache-Control` ヘッダが `max-age=1296000, stale-while-revalidate=1296000` である

### 備考

- TC-401と同じ内容だが、公開画面カテゴリとしても記載

---

## TC-005 記事詳細: 通常モードでNewt記事が表示される

| 項目 | 内容 |
|------|------|
| **機能ID** | F-002 |
| **カテゴリ** | 正常系 |

### 前提条件

- `features` Cookie は未設定（通常モード）
- Newt CMSに公開済み記事が存在する

### 手順

1. トップページで任意のNewt記事カードをクリックする
2. `/articles/{slug}` に遷移することを確認する

### 期待結果

- 記事タイトルが表示される
- 記事本文（HTML変換済み）が表示される
- カバー画像が表示される（設定されている場合）
- カテゴリが表示される
- 投稿日が `YYYY年MM月DD日` 形式で表示される

---

## TC-006 記事詳細: features=localでDB記事がslugで表示される

| 項目 | 内容 |
|------|------|
| **機能ID** | F-002 |
| **カテゴリ** | 正常系 |

### 前提条件

- `features=local` Cookie が設定されている
- DBに公開記事が1件以上存在し、そのスラッグが既知である（例: `test-article`）

### 手順

1. `http://127.0.0.1:3000/articles/{slug}` にアクセスする（`{slug}` はDB公開記事のスラッグ）

### 期待結果

- DB内の公開記事が表示される
- 記事タイトル、本文、カテゴリ、投稿日が正しく表示される

### 備考

- `features=local` 時はNewt CMSではなくDBからslugで検索される

---

## TC-007 記事詳細: features=localでNewtリダイレクトマッピング動作

| 項目 | 内容 |
|------|------|
| **機能ID** | F-002 |
| **カテゴリ** | 正常系 |

### 前提条件

- `features=local` Cookie が設定されている
- Newtリダイレクトマッピングに登録されたIDが既知である（Newt記事IDに対応するローカル記事slugマッピングが存在する）
- 対応するDB公開記事が存在する

### 手順

1. `http://127.0.0.1:3000/articles/{newt_id}` にアクセスする（`{newt_id}` はNewtリダイレクトマッピングに登録されたID）

### 期待結果

- リダイレクトが発生し、対応するDB記事のslugベースのURLに遷移する
- SSRアクセス時は301 Moved Permanentlyステータスが返される
- リダイレクト先の記事が正しく表示される

### 備考

- リダイレクトマッピングはNewt記事IDからローカルDB記事slugへの対応表

---

## TC-008 記事詳細: 存在しない記事で404表示

| 項目 | 内容 |
|------|------|
| **機能ID** | F-002 |
| **カテゴリ** | 異常系 |

### 前提条件

- サーバーが起動している

### 手順

1. `http://127.0.0.1:3000/articles/non-existent-article-slug-xyz` にアクセスする

### 期待結果

- 404ページが表示される
- HTTPステータスコードが404である

---

## TC-009 記事詳細: OGPメタタグの設定確認

| 項目 | 内容 |
|------|------|
| **機能ID** | F-002 |
| **カテゴリ** | 正常系 |

### 前提条件

- `features` Cookie は未設定（通常モード）
- Newt CMSに公開済み記事が存在する

### 手順

1. `http://127.0.0.1:3000/articles/{slug}` にアクセスする
2. ページソースまたはブラウザ開発者ツールで `<head>` 内のメタタグを確認する

### 期待結果

- `<title>` が記事タイトルを含む
- `<meta name="description">` が記事の説明文を含む
- `<meta property="og:title">` が記事タイトルを含む
- `<meta property="og:description">` が記事の説明文を含む
- `<meta property="og:image">` がカバー画像URLまたはOG画像URLを含む
- `<meta property="article:published_time">` が公開日時を含む

---

## TC-010 プレビュー: Newt未公開記事の表示

| 項目 | 内容 |
|------|------|
| **機能ID** | F-003 |
| **カテゴリ** | 正常系 |

### 前提条件

- Newt CMSに未公開（下書き）の記事が存在し、そのIDが既知である

### 手順

1. `http://127.0.0.1:3000/preview/{id}` にアクセスする（`{id}` はNewt CMSの未公開記事ID）

### 期待結果

- 未公開記事が記事詳細と同じレイアウトで表示される
- 記事タイトル、本文、カテゴリ、投稿日が正しく表示される

### 備考

- プレビューは認証不要（URLを知っていればアクセス可能）

---

## TC-011 プレビュー: 存在しないIDで404表示

| 項目 | 内容 |
|------|------|
| **機能ID** | F-003 |
| **カテゴリ** | 異常系 |

### 前提条件

- サーバーが起動している

### 手順

1. `http://127.0.0.1:3000/preview/non-existent-id-xyz` にアクセスする

### 期待結果

- 404ページが表示される
- HTTPステータスコードが404である

---

## TC-012 プレビュー: キャッシュ無効化ヘッダ確認

| 項目 | 内容 |
|------|------|
| **機能ID** | F-003 |
| **カテゴリ** | 正常系 |

### 前提条件

- Newt CMSに記事が存在し、そのIDが既知である

### 手順

1. `http://127.0.0.1:3000/preview/{id}` にアクセスする
2. ブラウザの開発者ツール > ネットワークタブでレスポンスヘッダを確認する

### 期待結果

- `Cache-Control` ヘッダが `no-cache, must-revalidate, no-store, max-age=0, stale-while-revalidate=0, private` を含む
- `CDN-Cache-Control` ヘッダが `no-cache, must-revalidate, no-store, max-age=0, stale-while-revalidate=0, private` を含む

### 備考

- プレビューページは常にキャッシュ無効化される（features=local の有無に関係なく）
