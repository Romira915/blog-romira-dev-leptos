# 認証テストケース

## TC-301 OAuth: ログインボタン→Google認証→管理画面リダイレクト

| 項目 | 内容 |
|------|------|
| **機能ID** | F-201 |
| **カテゴリ** | 正常系 |

### 前提条件

- OAuth環境変数が設定されている（`GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`, `APP_URL`）
- Google Workspaceアカウントが利用可能である
- 未ログイン状態である

### 手順

1. `http://127.0.0.1:3000/admin` にアクセスする
2. ログインオーバーレイが表示されることを確認する
3. 「Googleでログイン」ボタンをクリックする
4. Google認証ページにリダイレクトされることを確認する
5. Google Workspaceアカウントでログインする

### 期待結果

- `/auth/google` → Google認証ページ → `/auth/callback` → `/admin` の順でリダイレクトされる
- 最終的に `/admin` にリダイレクトされ、管理画面が操作可能になる
- ログインオーバーレイが消える
- ユーザーのメールアドレスが管理画面のサイドバーに表示される
- ログアウトリンクが表示される
- セッションに `AuthUser { email, name, picture }` が保存される

---

## TC-302 OAuth: 未設定時は「認証なし」表示で操作可能

| 項目 | 内容 |
|------|------|
| **機能ID** | F-201 |
| **カテゴリ** | 正常系 |

### 前提条件

- OAuth環境変数が**未設定**である（`GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`, `APP_URL` のいずれかまたはすべてが未設定）

### 手順

1. `http://127.0.0.1:3000/admin` にアクセスする

### 期待結果

- ログインオーバーレイが表示されない
- 「認証なし」の旨が表示される
- 管理画面の全機能（記事一覧、記事編集、画像管理）が操作可能である
- 「Googleでログイン」ボタンは表示されない

### 備考

- OAuth3項目（`google_client_id`, `google_client_secret`, `app_url`）のすべてが `Some` の場合のみOAuth有効

---

## TC-303 OAuth: 設定済み+未認証時はログインオーバーレイ表示

| 項目 | 内容 |
|------|------|
| **機能ID** | F-201 |
| **カテゴリ** | 正常系 |

### 前提条件

- OAuth環境変数が設定されている
- 未ログイン状態である（セッションにユーザー情報がない）

### 手順

1. `http://127.0.0.1:3000/admin` にアクセスする

### 期待結果

- 管理画面のコンテンツが背景に描画される
- ログインオーバーレイ（CSSクラス: `login_overlay` + `login_required`）が表示される
- 「ログインが必要です」メッセージが表示される
- 「Googleでログイン」ボタンが表示される
- オーバーレイにより管理画面のコンテンツは操作不能になる

### 備考

- UIレベルのガードのみ（DevToolsでオーバーレイを無効化すれば操作可能 — 仕様上の制約）

---

## TC-304 ログアウト: セッション削除→トップページリダイレクト

| 項目 | 内容 |
|------|------|
| **機能ID** | F-202 |
| **カテゴリ** | 正常系 |

### 前提条件

- OAuth環境変数が設定されている
- ログイン済み状態である（セッションにユーザー情報がある）

### 手順

1. `http://127.0.0.1:3000/admin` にアクセスする
2. サイドバーのログアウトリンクをクリックする

### 期待結果

- `/auth/logout` にアクセスされる
- セッションから `user` キーが削除される
- トップページ（`/`）にリダイレクトされる
- 再度 `/admin` にアクセスすると、ログインオーバーレイが表示される（未認証状態に戻る）

### 備考

- Googleトークンの無効化は行われない（Googleセッションは残る）

---

## TC-305 OAuth: CSRFトークン不一致でエラーリダイレクト

| 項目 | 内容 |
|------|------|
| **機能ID** | F-201 |
| **カテゴリ** | 異常系 |

### 前提条件

- OAuth環境変数が設定されている

### 手順

1. `/auth/callback?code=test_code&state=invalid_csrf_token` にブラウザから直接アクセスする（不正なCSRFトークンを含むURL）

### 期待結果

- `/admin?error=csrf_mismatch` にリダイレクトされる
- セッションにユーザー情報は保存されない
- 管理画面でエラー情報が表示される（`error=csrf_mismatch` クエリパラメータ）

### 備考

- CSRFトークンはセッションに保存された値と `state` パラメータを照合して検証される
- セッション切れの場合もCSRF不一致として扱われる

---

## TC-306 features Cookie: トグルON→DB記事表示に切替

| 項目 | 内容 |
|------|------|
| **機能ID** | — |
| **カテゴリ** | 正常系 |

### 前提条件

- 管理画面にアクセス可能である
- `features` Cookie が未設定の状態である
- DBに公開記事が1件以上存在する

### 手順

1. `http://127.0.0.1:3000/admin` にアクセスする
2. サイドバーの「ローカル記事表示」トグルをONにする
3. トップページ（`/`）にアクセスする

### 期待結果

- トグルをONにすると `features=local` Cookie が設定される（`path=/`）
- トップページでDB記事（ソース: `Local`）が表示される
- 記事詳細ページでDBの公開記事がslugで表示される

---

## TC-307 features Cookie: トグルOFF→Newt記事表示に戻る

| 項目 | 内容 |
|------|------|
| **機能ID** | — |
| **カテゴリ** | 正常系 |

### 前提条件

- `features=local` Cookie が設定されている状態である

### 手順

1. `http://127.0.0.1:3000/admin` にアクセスする
2. サイドバーの「ローカル記事表示」トグルをOFFにする
3. トップページ（`/`）にアクセスする

### 期待結果

- トグルをOFFにすると `features` Cookie が削除される（`max-age=0`）
- トップページでDB記事が表示されなくなる
- 記事詳細はNewt CMSから取得される（通常モードに戻る）
