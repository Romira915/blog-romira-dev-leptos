# 認証テストケース

## TC-301 OAuth: ログインボタン→Google認証→管理画面リダイレクト

| 項目 | 内容 |
|------|------|
| **機能ID** | F-201 |
| **カテゴリ** | 正常系 |

### 前提条件

- OAuth環境変数が設定されている（`GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`, `APP_URL`）
- Google Workspaceアカウントが利用可能である
- 未ログイン状態である

### 手順

1. `http://127.0.0.1:3000/admin` にアクセスする
2. ログインオーバーレイが表示されることを確認する
3. 「Googleでログイン」ボタンをクリックする
4. Google認証ページにリダイレクトされることを確認する
5. Google Workspaceアカウントでログインする

### 期待結果

- `/auth/google` → Google認証ページ → `/auth/callback` → `/admin` の順でリダイレクトされる
- 最終的に `/admin` にリダイレクトされ、管理画面が操作可能になる
- ログインオーバーレイが消える
- ユーザーのメールアドレスが管理画面のサイドバーに表示される
- ログアウトリンクが表示される
- セッションに `AuthUser { email, name, picture }` が保存される

---

## TC-302 OAuth: 未設定時は「認証なし」表示で操作可能

| 項目 | 内容 |
|------|------|
| **機能ID** | F-201 |
| **カテゴリ** | 正常系 |
| **テスト可否** | **テスト不可**（現在の実装では実行不可能） |

### 前提条件

- OAuth環境変数が**未設定**である（`GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`, `APP_URL` のいずれかまたはすべてが未設定）

### 手順

1. `http://127.0.0.1:3000/admin` にアクセスする

### 期待結果

- ログインオーバーレイが表示されない
- 「認証なし」の旨が表示される
- 管理画面の全機能（記事一覧、記事編集、画像管理）が操作可能である
- 「Googleでログイン」ボタンは表示されない

### 備考

- **テスト不可の理由**: 現在の実装では `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`, `APP_URL`, `ADMIN_EMAILS` は全て必須の環境変数であり、未設定の場合はアプリケーション起動時にパニックする（`ServerConfig` の `envy::from_env().expect()`）。そのためOAuth未設定の状態をテストすることができない
- UIレベルの `is_oauth_configured()` チェックは残存しているが、到達不能コードとなっている
- 将来的にOAuth設定をオプション化する場合に本テストケースが有効になる

---

## TC-303 OAuth: 設定済み+未認証時はログインオーバーレイ表示

| 項目 | 内容 |
|------|------|
| **機能ID** | F-201 |
| **カテゴリ** | 正常系 |

### 前提条件

- OAuth環境変数が設定されている
- 未ログイン状態である（セッションにユーザー情報がない）

### 手順

1. `http://127.0.0.1:3000/admin` にアクセスする

### 期待結果

- 管理画面のコンテンツが背景に描画される
- ログインオーバーレイ（CSSクラス: `login_overlay` + `login_required`）が表示される
- 「ログインが必要です」メッセージが表示される
- 「Googleでログイン」ボタンが表示される
- オーバーレイにより管理画面のコンテンツは操作不能になる

### 備考

- UIレベルのガードのみ（DevToolsでオーバーレイを無効化すれば操作可能 — 仕様上の制約）

---

## TC-304 ログアウト: セッション削除→トップページリダイレクト

| 項目 | 内容 |
|------|------|
| **機能ID** | F-202 |
| **カテゴリ** | 正常系 |

### 前提条件

- OAuth環境変数が設定されている
- ログイン済み状態である（セッションにユーザー情報がある）

### 手順

1. `http://127.0.0.1:3000/admin` にアクセスする
2. サイドバーのログアウトリンクをクリックする

### 期待結果

- `/auth/logout` にアクセスされる
- セッションから `user` キーが削除される
- トップページ（`/`）にリダイレクトされる
- 再度 `/admin` にアクセスすると、ログインオーバーレイが表示される（未認証状態に戻る）

### 備考

- Googleトークンの無効化は行われない（Googleセッションは残る）

---

## TC-305 OAuth: CSRFトークン不一致でエラーリダイレクト

| 項目 | 内容 |
|------|------|
| **機能ID** | F-201 |
| **カテゴリ** | 異常系 |

### 前提条件

- OAuth環境変数が設定されている

### 手順

1. `/auth/callback?code=test_code&state=invalid_csrf_token` にブラウザから直接アクセスする（不正なCSRFトークンを含むURL）

### 期待結果

- `/admin?error=csrf_mismatch` にリダイレクトされる
- セッションにユーザー情報は保存されない
- 管理画面でエラー情報が表示される（`error=csrf_mismatch` クエリパラメータ）

### 備考

- CSRFトークンはセッションに保存された値と `state` パラメータを照合して検証される
- セッション切れの場合もCSRF不一致として扱われる

---

## TC-306 features Cookie: トグルON→DB記事表示に切替

| 項目 | 内容 |
|------|------|
| **機能ID** | — |
| **カテゴリ** | 正常系 |

### 前提条件

- 管理画面にアクセス可能である
- `features` Cookie が未設定の状態である
- DBに公開記事が1件以上存在する

### 手順

1. `http://127.0.0.1:3000/admin` にアクセスする
2. サイドバーの「ローカル記事表示」トグルをONにする
3. トップページ（`/`）にアクセスする

### 期待結果

- トグルをONにすると `features=local` Cookie が設定される（`path=/`）
- トップページでDB記事（ソース: `Local`）が表示される
- 記事詳細ページでDBの公開記事がslugで表示される

---

## TC-307 features Cookie: トグルOFF→Newt記事表示に戻る

| 項目 | 内容 |
|------|------|
| **機能ID** | — |
| **カテゴリ** | 正常系 |

### 前提条件

- `features=local` Cookie が設定されている状態である

### 手順

1. `http://127.0.0.1:3000/admin` にアクセスする
2. サイドバーの「ローカル記事表示」トグルをOFFにする
3. トップページ（`/`）にアクセスする

### 期待結果

- トグルをOFFにすると `features` Cookie が削除される（`max-age=0`）
- トップページでDB記事が表示されなくなる
- 記事詳細はNewt CMSから取得される（通常モードに戻る）

---

## TC-308 ADMIN_EMAILS: 許可外メールアドレスで403エラー

| 項目 | 内容 |
|------|------|
| **機能ID** | F-201 |
| **カテゴリ** | 異常系 |

### 前提条件

- OAuth環境変数が設定されている
- `ADMIN_EMAILS` に許可メールアドレスが設定されている（例: `admin@example.com`）
- 許可リストに**含まれない**Googleアカウントが利用可能である

### 手順

1. `http://127.0.0.1:3000/admin` にアクセスする
2. 「Googleでログイン」ボタンをクリックする
3. 許可リストに含まれないGoogleアカウントでログインする

### 期待結果

- OAuthフロー自体は正常に完了する（Googleの認証ページは表示される）
- コールバック後、403 Forbidden が返される
- セッションが破棄される（フラッシュされる）
- 管理画面の操作ができない
- サーバーログに `Unauthorized login attempt: {email}` のWARNが出力される

### 備考

- `ADMIN_EMAILS` はカンマ区切りで複数メールアドレスを指定可能
- メールアドレスの照合は大文字小文字を区別しない

---

## TC-309 ADMIN_EMAILS: 許可メールアドレスでアクセス成功

| 項目 | 内容 |
|------|------|
| **機能ID** | F-201 |
| **カテゴリ** | 正常系 |

### 前提条件

- OAuth環境変数が設定されている
- `ADMIN_EMAILS` に許可メールアドレスが設定されている（例: `admin@example.com`）
- 許可リストに**含まれる**Googleアカウントが利用可能である

### 手順

1. `http://127.0.0.1:3000/admin` にアクセスする
2. 「Googleでログイン」ボタンをクリックする
3. 許可リストに含まれるGoogleアカウントでログインする

### 期待結果

- OAuthフローが正常に完了する
- `/admin` にリダイレクトされ、管理画面が操作可能になる
- ユーザーのメールアドレスがサイドバーに表示される
- 管理API（記事一覧、画像一覧等）が正常に動作する

### 備考

- TC-301 と類似するが、本ケースは `ADMIN_EMAILS` による認可チェックを明示的に確認する
