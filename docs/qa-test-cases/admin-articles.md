# 管理機能 — 記事テストケース

## TC-101 記事一覧: 下書き・公開記事が統合表示される

| 項目 | 内容 |
|------|------|
| **機能ID** | F-101 |
| **カテゴリ** | 正常系 |

### 前提条件

- サーバーが起動している
- DBに下書き記事と公開記事がそれぞれ1件以上存在する
- 管理画面にアクセス可能である（OAuth未設定、または認証済み）

### 手順

1. `http://127.0.0.1:3000/admin` にアクセスする

### 期待結果

- 記事一覧が表示される
- 下書き記事と公開記事の両方が一覧に含まれる
- 各記事にタイトルが表示される
- 各記事に状態（下書き / 公開）が表示される
- 公開記事には公開日時が `YYYY年MM月DD日` 形式で表示される
- 下書き記事の公開日時は表示されない（`None`）

---

## TC-102 記事一覧: 各記事にエディタへのリンクがある

| 項目 | 内容 |
|------|------|
| **機能ID** | F-101 |
| **カテゴリ** | 正常系 |

### 前提条件

- DBに記事が1件以上存在する
- 管理画面にアクセス可能である

### 手順

1. `http://127.0.0.1:3000/admin` にアクセスする
2. 記事一覧から任意の記事をクリックする

### 期待結果

- `/admin/articles/{id}` に遷移する
- エディタページが表示される

---

## TC-103 記事作成: 新規下書きが保存できる

| 項目 | 内容 |
|------|------|
| **機能ID** | F-102 |
| **カテゴリ** | 正常系 |

### 前提条件

- 管理画面にアクセス可能である

### 手順

1. `http://127.0.0.1:3000/admin/articles/new` にアクセスする
2. タイトルに「テスト記事タイトル」と入力する
3. スラッグに `test-article` と入力する
4. 本文に「テスト本文です」と入力する
5. 「下書き保存」ボタンをクリックする

### 期待結果

- 保存が成功し、エラーが表示されない
- `draft_articles` テーブルに新規レコードが作成される
- 保存後、エディタページのURLが `/admin/articles/{生成されたID}` に変わる

### 備考

- IDはクライアント側で生成されるUUID

---

## TC-104 記事作成: 下書き保存はバリデーションなし（空タイトル・空スラッグ許可）

| 項目 | 内容 |
|------|------|
| **機能ID** | F-102 |
| **カテゴリ** | 正常系 |

### 前提条件

- 管理画面にアクセス可能である

### 手順

1. `http://127.0.0.1:3000/admin/articles/new` にアクセスする
2. タイトル、スラッグ、本文をすべて空のままにする
3. 「下書き保存」ボタンをクリックする

### 期待結果

- バリデーションエラーが発生せず、保存が成功する
- `draft_articles` テーブルにタイトル・スラッグ・本文が空のレコードが作成される

### 備考

- 仕様書（06-validation.md §6.1）: 下書き保存では一切のバリデーションを行わない

---

## TC-105 記事編集: 下書き記事の読み込み・更新

| 項目 | 内容 |
|------|------|
| **機能ID** | F-103 |
| **カテゴリ** | 正常系 |

### 前提条件

- DBに下書き記事が1件存在し、そのIDが既知である

### 手順

1. `http://127.0.0.1:3000/admin/articles/{id}` にアクセスする
2. エディタに下書き記事の現在の値がプリセットされていることを確認する
3. タイトルを「更新後タイトル」に変更する
4. 「下書き保存」ボタンをクリックする

### 期待結果

- エディタに既存の下書き記事のタイトル・スラッグ・本文・説明文がプリセットされる
- 「下書き保存」ボタンと「公開」ボタンが表示される（下書き記事のため）
- 保存が成功し、タイトルが「更新後タイトル」に更新される
- `draft_articles` テーブルの `updated_at` が更新される

---

## TC-106 記事編集: 公開記事の読み込み・更新

| 項目 | 内容 |
|------|------|
| **機能ID** | F-103 |
| **カテゴリ** | 正常系 |

### 前提条件

- DBに公開記事が1件存在し、そのIDが既知である
- 公開記事のタイトルが1文字以上、スラッグが `[a-z0-9\-_]+` 形式である

### 手順

1. `http://127.0.0.1:3000/admin/articles/{id}` にアクセスする
2. エディタに公開記事の現在の値がプリセットされていることを確認する
3. 本文を「更新後の本文」に変更する
4. 「保存」ボタンをクリックする

### 期待結果

- エディタに既存の公開記事のタイトル・スラッグ・本文・説明文がプリセットされる
- 「保存」ボタンが表示される（公開記事のため）
- 「下書き保存」「公開」ボタンは表示されない
- 保存が成功し、本文が更新される
- `published_articles` テーブルの `updated_at` が更新される

---

## TC-107 記事公開: 下書き→公開への変換

| 項目 | 内容 |
|------|------|
| **機能ID** | F-104 |
| **カテゴリ** | 正常系 |

### 前提条件

- DBに下書き記事が1件存在する
- 下書き記事のスラッグが `[a-z0-9\-_]+` 形式で入力されている（例: `my-first-article`）
- 同一スラッグの公開記事が存在しない

### 手順

1. `http://127.0.0.1:3000/admin/articles/{id}` にアクセスする
2. スラッグが正しいフォーマットであることを確認する
3. 「公開」ボタンをクリックする

### 期待結果

- 公開が成功する
- `published_articles` テーブルに新規レコードが作成される
- `published_at` に現在時刻（UTC）が設定される
- `draft_articles` テーブルから元の下書きレコードが削除される
- カテゴリが下書きから公開にコピーされる
- エディタが公開記事モード（「保存」ボタン表示）に切り替わる

### 備考

- 公開操作は不可逆（公開→下書きへの戻しは未実装）

---

## TC-108 記事公開: スラッグ空でバリデーションエラー

| 項目 | 内容 |
|------|------|
| **機能ID** | F-104 |
| **カテゴリ** | 異常系 |

### 前提条件

- DBに下書き記事が1件存在する
- 下書き記事のスラッグが空文字である

### 手順

1. `http://127.0.0.1:3000/admin/articles/{id}` にアクセスする
2. スラッグを空のままにする
3. 「公開」ボタンをクリックする

### 期待結果

- バリデーションエラーが表示される
- エラーメッセージ: `スラッグは必須です`
- `published_articles` にレコードが作成されない
- `draft_articles` のレコードが残存する

---

## TC-109 記事公開: スラッグ不正文字でバリデーションエラー

| 項目 | 内容 |
|------|------|
| **機能ID** | F-104 |
| **カテゴリ** | 異常系 |

### 前提条件

- DBに下書き記事が1件存在する

### 手順

1. `http://127.0.0.1:3000/admin/articles/{id}` にアクセスする
2. スラッグに `My-Article!` と入力する（大文字・記号を含む）
3. 「下書き保存」ボタンをクリックして下書きを更新する
4. 「公開」ボタンをクリックする

### 期待結果

- バリデーションエラーが表示される
- エラーメッセージ: `スラッグは半角英小文字、数字、ハイフン、アンダースコアのみ使用できます`
- `published_articles` にレコードが作成されない

### 備考

- スラッグの許可文字: `[a-z0-9\-_]` のみ

---

## TC-110 記事公開: スラッグ重複でエラー

| 項目 | 内容 |
|------|------|
| **機能ID** | F-104 |
| **カテゴリ** | 異常系 |

### 前提条件

- DBに公開記事が1件存在し、そのスラッグが `existing-slug` である
- DBに下書き記事が1件存在し、そのスラッグも `existing-slug` に設定されている

### 手順

1. 下書き記事のエディタ（`/admin/articles/{id}`）にアクセスする
2. スラッグが `existing-slug` であることを確認する
3. 「公開」ボタンをクリックする

### 期待結果

- エラーメッセージ: `このスラッグは既に使用されています`
- `published_articles` にレコードが作成されない
- `draft_articles` のレコードが残存する

---

## TC-111 公開記事保存: タイトル空でバリデーションエラー

| 項目 | 内容 |
|------|------|
| **機能ID** | F-103 |
| **カテゴリ** | 異常系 |

### 前提条件

- DBに公開記事が1件存在する

### 手順

1. 公開記事のエディタ（`/admin/articles/{id}`）にアクセスする
2. タイトルをすべて削除して空にする
3. 「保存」ボタンをクリックする

### 期待結果

- バリデーションエラーが表示される
- エラーメッセージ: `タイトルは必須です`
- `published_articles` のレコードが更新されない

### 備考

- 空白のみのタイトルも同様にエラーとなる（`trim()` で前後空白除去後に判定）

---

## TC-112 公開記事保存: タイトル201文字でバリデーションエラー

| 項目 | 内容 |
|------|------|
| **機能ID** | F-103 |
| **カテゴリ** | 境界値 |

### 前提条件

- DBに公開記事が1件存在する

### 手順

1. 公開記事のエディタ（`/admin/articles/{id}`）にアクセスする
2. タイトルに201文字の文字列を入力する（例: `あ` を201回繰り返す）
3. 「保存」ボタンをクリックする

### 期待結果

- バリデーションエラーが表示される
- エラーメッセージ: `タイトルは200文字以内で入力してください`
- `published_articles` のレコードが更新されない

### 備考

- 文字数は `chars().count()` で判定（マルチバイト文字もそれぞれ1文字としてカウント）

---

## TC-113 公開記事保存: タイトル200文字で保存成功

| 項目 | 内容 |
|------|------|
| **機能ID** | F-103 |
| **カテゴリ** | 境界値 |

### 前提条件

- DBに公開記事が1件存在する
- スラッグが有効な値に設定されている

### 手順

1. 公開記事のエディタ（`/admin/articles/{id}`）にアクセスする
2. タイトルにちょうど200文字の文字列を入力する（例: `あ` を200回繰り返す）
3. 「保存」ボタンをクリックする

### 期待結果

- バリデーションエラーが発生せず、保存が成功する
- `published_articles` のタイトルが200文字の文字列に更新される

---

## TC-114 公開記事保存: スラッグ大文字でバリデーションエラー

| 項目 | 内容 |
|------|------|
| **機能ID** | F-103 |
| **カテゴリ** | 異常系 |

### 前提条件

- DBに公開記事が1件存在する

### 手順

1. 公開記事のエディタ（`/admin/articles/{id}`）にアクセスする
2. スラッグに `My-Article` と入力する（大文字 `M` と `A` を含む）
3. 「保存」ボタンをクリックする

### 期待結果

- バリデーションエラーが表示される
- エラーメッセージ: `スラッグは半角英小文字、数字、ハイフン、アンダースコアのみ使用できます`
- `published_articles` のレコードが更新されない

---

## TC-115 公開記事保存: スラッグ重複（他記事）でエラー

| 項目 | 内容 |
|------|------|
| **機能ID** | F-103 |
| **カテゴリ** | 異常系 |

### 前提条件

- DBに公開記事が2件以上存在する
- 記事Aのスラッグが `article-a`、記事Bのスラッグが `article-b` である

### 手順

1. 記事Bのエディタ（`/admin/articles/{記事BのID}`）にアクセスする
2. スラッグを `article-a` に変更する（記事Aと同じスラッグ）
3. 「保存」ボタンをクリックする

### 期待結果

- エラーメッセージ: `このスラッグは既に使用されています`
- 記事Bのスラッグが `article-b` のまま変更されない

---

## TC-116 公開記事保存: 自身のスラッグ保持は成功

| 項目 | 内容 |
|------|------|
| **機能ID** | F-103 |
| **カテゴリ** | 正常系 |

### 前提条件

- DBに公開記事が1件存在し、スラッグが `my-article` である

### 手順

1. 公開記事のエディタ（`/admin/articles/{id}`）にアクセスする
2. スラッグを変更せず `my-article` のまま保持する
3. 本文のみ変更する
4. 「保存」ボタンをクリックする

### 期待結果

- スラッグ重複エラーが発生しない（自身のIDを除外して重複チェックされるため）
- 保存が成功し、本文が更新される

### 備考

- スラッグ重複チェックは自身のIDを除外して実施される（仕様書 06-validation.md §6.2.3）

---

## TC-117 公開記事保存: スラッグ空でバリデーションエラー

| 項目 | 内容 |
|------|------|
| **機能ID** | F-103 |
| **カテゴリ** | 異常系 |

### 前提条件

- DBに公開記事が1件存在する

### 手順

1. 公開記事のエディタ（`/admin/articles/{id}`）にアクセスする
2. スラッグをすべて削除して空にする
3. 「保存」ボタンをクリックする

### 期待結果

- バリデーションエラーが表示される
- エラーメッセージ: `スラッグは必須です`
- `published_articles` のレコードが更新されない

### 備考

- TC-108 は `publish_article`（F-104）のスラッグ空テスト。本ケースは `save_published`（F-103）のスラッグ空テスト

---

## TC-118 エディタ: Markdownプレビューの表示確認

| 項目 | 内容 |
|------|------|
| **機能ID** | F-103 |
| **カテゴリ** | 正常系 |

### 前提条件

- 管理画面にアクセス可能である

### 手順

1. `http://127.0.0.1:3000/admin/articles/new` にアクセスする
2. 本文に以下のMarkdownを入力する:
   ```
   # 見出し1
   **太字テキスト** と *斜体テキスト*
   - リスト項目1
   - リスト項目2
   ```
3. エディタツールバーのビューモードボタンで「Split」（分割表示）モードを確認する
4. 「Preview」（プレビューのみ）モードに切り替える
5. 「Editor」（エディタのみ）モードに切り替える

### 期待結果

- Splitモードでエディタとプレビューが左右に分割表示される
- プレビューエリアにMarkdownがHTMLに変換されて表示される:
  - `# 見出し1` → `<h1>` として表示
  - `**太字テキスト**` → 太字で表示
  - `*斜体テキスト*` → 斜体で表示
  - リスト項目が箇条書きで表示
- Previewモードでプレビューのみが全幅表示される
- Editorモードでエディタのみが全幅表示される
- アクティブなモードボタンのスタイルが他と異なる

---

## TC-119 エディタ: フルスクリーンモードの切り替え

| 項目 | 内容 |
|------|------|
| **機能ID** | F-103 |
| **カテゴリ** | 正常系 |

### 前提条件

- 管理画面にアクセス可能である
- 記事エディタを開いている

### 手順

1. `http://127.0.0.1:3000/admin/articles/new` にアクセスする
2. エディタツールバーの「全画面」ボタンをクリックする
3. Escapeキーを押す

### 期待結果

- 「全画面」ボタンクリック後:
  - ヘッダー（タイトル・スラッグ・説明文の入力フォーム）が非表示になる
  - エディタワークスペースがフルスクリーン表示される
  - ボタンのテキストが「全画面解除」に変わる
- Escapeキー押下後:
  - フルスクリーンモードが解除される
  - ヘッダーが再表示される
  - ボタンのテキストが「全画面」に戻る

---

## TC-120 記事一覧: 新規作成ボタンでエディタに遷移

| 項目 | 内容 |
|------|------|
| **機能ID** | F-101 |
| **カテゴリ** | 正常系 |

### 前提条件

- 管理画面にアクセス可能である

### 手順

1. `http://127.0.0.1:3000/admin` にアクセスする
2. サイドバーの「新規作成」リンクをクリックする

### 期待結果

- `/admin/articles/new` に遷移する
- 空の記事エディタが表示される（タイトル・スラッグ・本文が空）
- 「下書き保存」ボタンと「公開」ボタンが表示される

---

## TC-121 カバー画像設定: 画像ライブラリから選択してカバー画像を設定

| 項目 | 内容 |
|------|------|
| **機能ID** | F-109 |
| **カテゴリ** | 正常系 |

### 前提条件

- 管理画面にアクセス可能である
- 画像が1件以上アップロード済みである（`/admin/images` に表示される）
- 記事エディタで下書きまたは公開記事を編集中である
- カバー画像が未設定の状態である

### 手順

1. 記事エディタ（`/admin/articles/{id}`）にアクセスする
2. カバー画像セクションの「選択」ボタンをクリックする
3. ImagePickerModal（画像ライブラリ）が開くことを確認する
4. 任意の画像を選択する

### 期待結果

- 「選択」ボタンクリックでImagePickerModalが表示される
- 画像を選択すると、カバー画像URLにimgix URLが設定される
- エディタ上でカバー画像のプレビューが表示される
- ボタンが「変更」と「解除」に切り替わる
- 記事を保存すると、カバー画像URLが永続化される

---

## TC-122 カバー画像設定: 設定済みカバー画像の変更

| 項目 | 内容 |
|------|------|
| **機能ID** | F-109 |
| **カテゴリ** | 正常系 |

### 前提条件

- カバー画像が既に設定された記事が存在する
- 画像が2件以上アップロード済みである

### 手順

1. カバー画像が設定された記事のエディタにアクセスする
2. 現在のカバー画像がプレビュー表示されていることを確認する
3. 「変更」ボタンをクリックする
4. ImagePickerModalから別の画像を選択する
5. 記事を保存する

### 期待結果

- カバー画像URLが新しい画像のimgix URLに更新される
- プレビューが新しい画像に切り替わる
- 保存後、再読み込みしても新しいカバー画像が表示される

---

## TC-123 カバー画像設定: カバー画像の解除

| 項目 | 内容 |
|------|------|
| **機能ID** | F-109 |
| **カテゴリ** | 正常系 |

### 前提条件

- カバー画像が既に設定された記事が存在する

### 手順

1. カバー画像が設定された記事のエディタにアクセスする
2. 「解除」ボタンをクリックする
3. 記事を保存する

### 期待結果

- カバー画像URLがクリアされる
- カバー画像のプレビューが非表示になる
- ボタンが「選択」に戻る
- 保存後、`features=local` + 記事詳細ページでカバー画像が表示されない

---

## TC-124 本文画像挿入: 画像ライブラリから選択してHTML挿入

| 項目 | 内容 |
|------|------|
| **機能ID** | F-110 |
| **カテゴリ** | 正常系 |

### 前提条件

- 管理画面にアクセス可能である
- 画像が1件以上アップロード済みである
- 記事エディタで本文を編集中である

### 手順

1. 記事エディタ（`/admin/articles/{id}`）にアクセスする
2. 本文のテキストエリアにカーソルを置く
3. エディタツールバーの「画像挿入」ボタンをクリックする
4. ImagePickerModalから任意の画像を選択する

### 期待結果

- ImagePickerModalが開く
- 画像を選択すると、本文のカーソル位置にレスポンシブHTML `<img>` タグが挿入される:
  - `src` 属性にimgix URL（`auto=format&q=75`）
  - `srcset` 属性に複数幅のレスポンシブ画像セット
  - `sizes` 属性に `(max-width: 800px) 100vw, 800px`
  - `loading="lazy"` 属性
- 挿入後もテキストエリアの編集を継続できる

### 備考

- Markdown形式（`![alt](url)`）ではなく、生HTML `<img>` タグが挿入される（レスポンシブ対応のため）

---

## TC-125 本文画像挿入: 挿入されたHTMLがプレビューで画像表示される

| 項目 | 内容 |
|------|------|
| **機能ID** | F-110 |
| **カテゴリ** | 正常系 |

### 前提条件

- TC-124 の手順で本文にHTML画像タグが挿入された状態

### 手順

1. エディタのMarkdownプレビューエリアを確認する

### 期待結果

- Markdownプレビューに画像が表示される
- 画像のURLがimgix CDN経由のURLである
- 記事を保存し、`features=local` + 記事詳細ページで確認すると、本文中にレスポンシブ画像が表示される
