# 管理機能 — 画像テストケース

## TC-201 画像一覧: アップロード済み画像がグリッド表示される

| 項目 | 内容 |
|------|------|
| **機能ID** | F-105 |
| **カテゴリ** | 正常系 |

### 前提条件

- サーバーが起動している
- DBに画像レコードが1件以上存在する（事前にアップロード済み）
- 管理画面にアクセス可能である

### 手順

1. `http://127.0.0.1:3000/admin/images` にアクセスする

### 期待結果

- 画像がグリッド形式で一覧表示される
- 各画像にサムネイルが表示される
- 各画像にファイル名が表示される
- 各画像にファイルサイズが表示される
- 各画像にimgix URLのコピーボタンが表示される
- 各画像に削除ボタンが表示される

---

## TC-202 画像アップロード: JPEG画像のアップロード成功（3ステップ）

| 項目 | 内容 |
|------|------|
| **機能ID** | F-106 |
| **カテゴリ** | 正常系 |

### 前提条件

- 管理画面にアクセス可能である
- GCSの署名付きURL生成が正常に動作する（`GCS_SERVICE_ACCOUNT_KEY_JSON` 環境変数が設定済み）
- テスト用のJPEG画像ファイル（10MB以下）を用意する

### 手順

1. `http://127.0.0.1:3000/admin/images` にアクセスする
2. アップロードエリアの「クリックしてファイルを選択」をクリックする
3. テスト用のJPEG画像を選択する

### 期待結果

- 以下の3ステップが自動的に実行される:
  1. サーバーに署名付きURL生成リクエストが送信される（`admin/images/upload-url`）
  2. 署名付きURLを使ってGCSにファイルが直接PUTされる
  3. サーバーにDB登録リクエストが送信される（`admin/images` POST）
- アップロードが完了し、画像一覧に新しい画像が追加される
- 追加された画像のMIMEタイプが `image/jpeg` である
- imgix URLが生成される

### 備考

- 3ステップ処理のため、途中でエラーが発生した場合のロールバックはない（仕様書 11-state-transitions.md §11.2）

---

## TC-203 画像アップロード: PNG/GIF/WebPも成功

| 項目 | 内容 |
|------|------|
| **機能ID** | F-106 |
| **カテゴリ** | 正常系 |

### 前提条件

- 管理画面にアクセス可能である
- GCSの署名付きURL生成が正常に動作する
- テスト用のPNG、GIF、WebP画像ファイル（各10MB以下）を用意する

### 手順

1. `http://127.0.0.1:3000/admin/images` にアクセスする
2. PNG画像をアップロードする
3. GIF画像をアップロードする
4. WebP画像をアップロードする

### 期待結果

- 3つの画像すべてがアップロードに成功する
- 各画像のMIMEタイプがそれぞれ `image/png`、`image/gif`、`image/webp` である
- 画像一覧に3つの新しい画像が追加される

### 備考

- 許可MIMEタイプ: `image/jpeg`, `image/png`, `image/gif`, `image/webp`

---

## TC-204 画像アップロード: 許可外MIMEタイプでエラー

| 項目 | 内容 |
|------|------|
| **機能ID** | F-106 |
| **カテゴリ** | 異常系 |

### 前提条件

- 管理画面にアクセス可能である
- テスト用のSVGファイル（`image/svg+xml`）またはBMPファイル（`image/bmp`）を用意する

### 手順

1. `http://127.0.0.1:3000/admin/images` にアクセスする
2. SVGファイルをアップロードしようとする

### 期待結果

- エラーメッセージが表示される
- エラーメッセージ: `許可されていないファイル形式です: image/svg+xml。許可: ["image/jpeg", "image/png", "image/gif", "image/webp"]`
- 画像がGCSにアップロードされない
- DBにレコードが作成されない

---

## TC-205 画像アップロード: 10MB超過でエラー

| 項目 | 内容 |
|------|------|
| **機能ID** | F-106 |
| **カテゴリ** | 境界値 |

### 前提条件

- 管理画面にアクセス可能である
- 10MB（10,485,760バイト）を超えるJPEG画像ファイルを用意する

### 手順

1. `http://127.0.0.1:3000/admin/images` にアクセスする
2. 10MBを超えるJPEG画像をアップロードしようとする

### 期待結果

- エラーメッセージが表示される
- エラーメッセージ: `ファイルサイズが大きすぎます: {size_mb}MB。最大: 10MB`
- 画像がGCSにアップロードされない（ステップ1のバリデーションで弾かれる）

### 備考

- 有効範囲: 1 ≤ `size_bytes` ≤ 10,485,760（10MB）
- 10,485,760バイトちょうどは有効、10,485,761バイト以上はエラー

---

## TC-206 画像アップロード: 0バイトでエラー

| 項目 | 内容 |
|------|------|
| **機能ID** | F-106 |
| **カテゴリ** | 境界値 |

### 前提条件

- 管理画面にアクセス可能である
- 0バイトのファイルを用意する

### 手順

1. `http://127.0.0.1:3000/admin/images` にアクセスする
2. 0バイトのファイルをアップロードしようとする

### 期待結果

- エラーメッセージが表示される
- エラーメッセージ: `ファイルサイズが不正です`
- 画像がGCSにアップロードされない

### 備考

- `size_bytes <= 0` の場合にエラーとなる

---

## TC-207 画像アップロード: D&Dでアップロード

| 項目 | 内容 |
|------|------|
| **機能ID** | F-106 |
| **カテゴリ** | 正常系 |

### 前提条件

- 管理画面にアクセス可能である
- GCSの署名付きURL生成が正常に動作する
- テスト用のJPEG画像ファイル（10MB以下）を用意する

### 手順

1. `http://127.0.0.1:3000/admin/images` にアクセスする
2. ファイルマネージャ（エクスプローラ/Finder）からテスト用画像をアップロードエリアにドラッグ&ドロップする

### 期待結果

- ドラッグ中にアップロードエリアのスタイルが変化する（ドロップ対象の視覚フィードバック）
- ドロップ後、アップロードが自動的に開始される
- アップロードが完了し、画像一覧に新しい画像が追加される

---

## TC-208 画像削除: DBレコード削除・一覧更新

| 項目 | 内容 |
|------|------|
| **機能ID** | F-107 |
| **カテゴリ** | 正常系 |

### 前提条件

- DBに画像レコードが1件以上存在する
- 画像一覧に画像が表示されている

### 手順

1. `http://127.0.0.1:3000/admin/images` にアクセスする
2. 削除対象の画像の削除ボタンをクリックする

### 期待結果

- `images` テーブルから対象レコードが削除される
- 画像一覧が更新され、削除した画像が表示されなくなる

---

## TC-209 画像削除: GCSファイルは残存すること

| 項目 | 内容 |
|------|------|
| **機能ID** | F-107 |
| **カテゴリ** | 正常系 |

### 前提条件

- DBに画像レコードが存在し、対応するGCSファイルも存在する
- 画像のGCSパスが既知である

### 手順

1. `http://127.0.0.1:3000/admin/images` にアクセスする
2. 対象画像のimgix URLを控えておく
3. 削除ボタンをクリックする
4. 削除後、控えておいたimgix URLにブラウザでアクセスする

### 期待結果

- DBレコードは削除される（画像一覧から消える）
- GCS上のファイルは削除されない（imgix URLで引き続きアクセス可能）

### 備考

- 仕様上、画像削除はDB上のレコードのみ削除する。GCS上のファイルは手動削除が必要（仕様書 02-features.md F-107）

---

## TC-210 画像URLコピー: imgix URLがクリップボードにコピー

| 項目 | 内容 |
|------|------|
| **機能ID** | F-108 |
| **カテゴリ** | 正常系 |

### 前提条件

- DBに画像レコードが1件以上存在する
- 画像一覧に画像が表示されている

### 手順

1. `http://127.0.0.1:3000/admin/images` にアクセスする
2. 任意の画像のURLコピーボタンをクリックする
3. テキストエディタ等に貼り付ける

### 期待結果

- クリップボードにimgix URLがコピーされる
- URLの形式: `https://{imgix_domain}/{gcs_path}`
- 貼り付けた結果がimgix URLと一致する

### 備考

- クライアントサイド処理のみ（Clipboard APIを使用）
