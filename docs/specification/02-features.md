# 2. 機能一覧

## 2.1 公開機能（認証不要）

### F-001 トップページ表示

全ソースの記事一覧を新着順で表示する。

- **事前条件**: なし
- **正常系フロー**:
  1. Newt CMS / WordPress / Qiita から記事を取得
  2. `features=local` Cookie が設定されている場合、DBの公開記事も取得して追加
  3. 全記事を `first_published_at` の降順でソート
  4. 記事カード（サムネイル、タイトル、カテゴリ、投稿日、ソース種別）の一覧を表示
- **異常系フロー**:
  - 外部サービス（Newt/WordPress/Qiita）のいずれかが失敗 → 500エラー
  - DB記事取得失敗（`features=local` 時のみ） → warnログのみ、他のソースの記事は表示される
- **事後条件**: キャッシュコントロールが設定される（通常: トップページキャッシュ、features=local: キャッシュ無効化）

### F-002 記事詳細表示

記事本文をHTMLに変換して表示する。

- **事前条件**: URLパス `/articles/{slug}` でアクセス
- **正常系フロー**:
  - **通常モード**: Newt CMSから記事IDで取得 → 記事本文・メタ情報を表示
  - **features=local モード**:
    1. DBから `slug` で公開記事を検索
    2. 見つかった場合: 記事本文・メタ情報を表示
    3. 見つからない場合: Newtリダイレクトマッピングを確認し、対応する記事があればリダイレクト
- **異常系フロー**:
  - 記事が見つからない → 404ページ表示
  - DB取得エラー（features=local時） → 500エラー
  - Newt CMSエラー（通常時） → 404として扱う
- **事後条件**: OGPメタタグ（title, description, og:image）が設定される

### F-003 プレビュー表示

Newt CMS上の未公開記事をプレビュー表示する。

- **事前条件**: URLパス `/preview/{id}` でアクセス（URLを知っていれば認証不要）
- **正常系フロー**:
  1. Newt CMSからプレビュー記事を取得
  2. 記事詳細と同じレイアウトで表示
- **異常系フロー**:
  - 記事が見つからない → 404ページ表示
  - Newt CMSエラー → 500エラー
- **事後条件**: キャッシュ無効化ヘッダが設定される（`no-cache, no-store, private`）

---

## 2.2 管理機能（認証必要）

### F-101 記事一覧

下書き・公開記事を統合して一覧表示する。

- **事前条件**: 管理画面にアクセス（UIレベル認証ガード）
- **正常系フロー**:
  1. `AdminArticleService::fetch_all()` で公開記事と下書きを統合取得
  2. 各記事のタイトル、状態（下書き/公開）、公開日時を表示
  3. 各記事にエディタページへのリンクを表示
- **異常系フロー**:
  - DB取得失敗 → エラーメッセージ表示
- **事後条件**: なし

### F-102 記事作成

新規記事を下書きとして作成する。

- **事前条件**: 管理画面にアクセス
- **正常系フロー**:
  1. エディタページ（`/admin/articles/new`）を開く
  2. クライアントで新しいUUIDを生成
  3. タイトル・スラッグ・本文・説明文を入力
  4. 「下書き保存」ボタンで `admin/save_draft` APIを呼び出し
  5. Upsert動作で `draft_articles` に保存
- **異常系フロー**:
  - DB保存失敗 → エラーメッセージ表示
- **事後条件**: `draft_articles` テーブルに新規レコードが作成される

### F-103 記事編集

既存記事（下書きまたは公開）を編集する。

- **事前条件**: エディタページ（`/admin/articles/{id}`）でアクセス
- **正常系フロー**:
  1. `admin/get_article` APIで記事データを取得（下書き優先、なければ公開記事）
  2. エディタに現在の値をプリセット
  3. **下書きの場合**: 「下書き保存」で `admin/save_draft` → 「公開」で `admin/publish_article`
  4. **公開記事の場合**: 「保存」で `admin/save_published`（バリデーション適用）
- **異常系フロー**:
  - 記事が見つからない → エラー表示
  - バリデーションエラー（公開記事保存時） → エラーメッセージ表示
- **事後条件**: 対応するテーブルのレコードが更新される

### F-104 記事公開

下書きを公開記事に変換する。

- **事前条件**: 対象が下書き記事であること
- **正常系フロー**:
  1. `admin/publish_article` APIを呼び出し
  2. スラッグのバリデーション + 重複チェック
  3. 下書き → 公開記事への変換（カテゴリもコピー）
  4. 下書きレコードの削除
- **異常系フロー**:
  - スラッグが空 / 不正な文字 → バリデーションエラー
  - スラッグ重複 → エラーメッセージ
  - 下書きが見つからない → 404エラー
- **事後条件**: `draft_articles` からレコード削除、`published_articles` に新規レコード作成

### F-105 画像一覧

アップロード済み画像をグリッド形式で一覧表示する。

- **事前条件**: 管理画面 `/admin/images` にアクセス
- **正常系フロー**:
  1. `admin/images` (GET) APIで全画像を取得
  2. 各画像のサムネイル、ファイル名、サイズ、imgix URLを表示
- **異常系フロー**:
  - DB取得失敗 → エラーメッセージ表示
- **事後条件**: なし

### F-106 画像アップロード

画像をGCSにアップロードしてDBに登録する（3ステップ処理）。

- **事前条件**: 管理画面 `/admin/images` にアクセス
- **正常系フロー**:
  1. ファイル選択またはドラッグ&ドロップで画像を選択
  2. `admin/images/upload-url` APIで署名付きURL + GCSパスを取得
  3. 署名付きURLを使ってGCSにファイルを直接PUT
  4. `admin/images` (POST) APIでDBに画像メタデータを登録
  5. 画像一覧を更新
- **異常系フロー**:
  - MIMEタイプが許可されていない → バリデーションエラー
  - ファイルサイズが不正（0以下 or 10MB超過） → バリデーションエラー
  - GCSアップロード失敗 → エラーメッセージ（DB登録はスキップ）
  - DB登録失敗 → エラーメッセージ（GCSにファイルは残存）
- **事後条件**: GCS上にファイルが存在し、`images` テーブルにレコードが作成される

### F-107 画像削除

アップロード済み画像のDBレコードを削除する。

- **事前条件**: 画像一覧に画像が表示されていること
- **正常系フロー**:
  1. 削除ボタンをクリック
  2. `admin/images/delete` APIでDBレコードを削除
  3. 画像一覧を更新
- **異常系フロー**:
  - DB削除失敗 → エラーメッセージ表示
- **事後条件**: `images` テーブルからレコードが削除される。**GCS上のファイルは削除されない**

### F-108 画像URLコピー

imgix配信URLをクリップボードにコピーする。

- **事前条件**: 画像一覧に画像が表示されていること
- **正常系フロー**:
  1. コピーボタンをクリック
  2. imgix URL（`https://{domain}/{gcs_path}`）をクリップボードにコピー
- **異常系フロー**: なし（クライアントサイド処理のみ）
- **事後条件**: クリップボードにURLがコピーされる

### F-109 カバー画像設定 (**未実装**)

エディタから画像ライブラリを開き、カバー画像を選択する。

### F-110 本文への画像挿入 (**未実装**)

エディタから画像ライブラリを開き、Markdown形式で本文に挿入する。

### F-111 記事削除 (**未実装**)

下書き・公開記事を管理画面から削除する。現在はDB直接操作でのみ対応。

---

## 2.3 認証機能

### F-201 Google OAuth認証

Google Workspaceアカウントでログインする。

- **事前条件**: OAuth環境変数（client_id, client_secret, app_url）が設定されていること
- **正常系フロー**:
  1. 管理画面の「Googleでログイン」ボタンをクリック
  2. `/auth/google` → Google認証ページにリダイレクト
  3. ユーザーがGoogleアカウントでログイン
  4. `/auth/callback` でトークン交換 → UserInfo取得
  5. セッションにユーザー情報を保存
  6. `/admin` にリダイレクト
- **異常系フロー**:
  - OAuth未設定 → `/admin?error=oauth_not_configured` にリダイレクト
  - CSRFトークン不一致 → `/admin?error=csrf_mismatch`
  - トークン交換失敗 → `/admin?error=token_exchange_failed`
  - UserInfo取得/解析失敗 → `/admin?error=userinfo_failed` / `userinfo_parse_failed`
  - セッション保存失敗 → `/admin?error=session_error`
- **事後条件**: セッションに `AuthUser { email, name, picture }` が保存される

### F-202 セッション管理

Cookie + サーバーサイドセッションで認証状態を管理する。

- **セッションストア**: PostgreSQL（`tower-sessions-sqlx-store`）
- **セッションキー**: `user`（AuthUser）、`oauth_csrf`（一時的CSRFトークン）
- **ログアウト**: `/auth/logout` でセッションからユーザー情報を削除し、`/` にリダイレクト
