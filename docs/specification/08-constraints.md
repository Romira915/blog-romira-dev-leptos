# 8. 制約事項

## 8.1 セキュリティ制約

### 認証・認可

| 制約 | 説明 | 影響範囲 |
|------|------|---------|
| プレビュー認証なし | `/preview/{id}` はURLを知っていれば誰でもアクセス可能 | プレビュー記事表示 |
| OAuth未設定時は管理機能全拒否 | 開発環境でもOAuth環境変数の設定が必須 | 全管理APIエンドポイント |
| ロール区別なし | 認証済みユーザーは全管理機能にアクセス可能 | 全管理APIエンドポイント |

### CSRF保護

| 保護対象 | 方式 | 範囲 |
|---------|------|------|
| OAuth認証フロー | セッションベースCSRFトークン（`state` パラメータ） | `/auth/google` → `/auth/callback` |
| 管理API | なし（Leptos Server Function経由） | `admin/*` 全エンドポイント |

### 組織制限

- Google Workspace の内部アプリとして設定
- 組織外ユーザーはGoogleログイン自体が不可
- この制限はGoogle Workspace設定に依存（アプリ側での検証なし）

---

## 8.2 データ整合性

### トランザクション未使用

以下の複合操作はトランザクションで囲まれておらず、途中失敗時にデータ不整合が発生する可能性がある。

| 操作 | ステップ | 失敗時のリスク |
|------|---------|-------------|
| 記事公開（`publish`） | 1. 公開記事INSERT → 2. カテゴリINSERT → 3. 下書きDELETE | 公開記事は作成されたが下書きが残る、カテゴリが部分的にコピーされる |

### 画像GCS残存

| 操作 | DBの状態 | GCSの状態 | 問題 |
|------|---------|----------|------|
| 画像アップロード（ステップ2成功、ステップ3失敗） | レコードなし | ファイル存在 | 孤立ファイル |
| 画像削除（`delete_image`） | レコード削除済み | ファイル存在 | 孤立ファイル |

GCS上の孤立ファイルは手動でのクリーンアップが必要。自動削除メカニズムは未実装。

### カスケード削除

- `published_article_categories` — `article_id` に ON DELETE CASCADE（記事削除時にカテゴリ関連も削除）
- `draft_article_categories` — 同上

---

## 8.3 パフォーマンス制約

### N+1問題

| 箇所 | 説明 |
|------|------|
| WordPress カテゴリ取得 | 各記事のカテゴリIDごとに個別APIリクエスト |
| Qiita OG画像取得 | 各記事のURLに対して個別にHTTPリクエスト + HTMLパース |

### ページネーション未実装

| エンドポイント | 影響 |
|-------------|------|
| `get_articles_handler` | 全ソースの全記事を一括取得（記事数増加に伴い応答時間増大） |
| `admin/get_articles` | 全記事を一括取得 |
| `admin/images` | 全画像を一括取得 |

### 外部API依存

トップページの表示は3つの外部サービス（Newt, WordPress, Qiita）に依存しており、いずれかの応答遅延がページ全体の表示速度に影響する。現在は順次取得であり、並列取得は未実装。

---

## 8.4 機能制約

### 未実装機能

| 機能 | 現状の代替手段 |
|------|-------------|
| 記事削除（公開記事・下書き） | DB直接操作 |
| カバー画像選択UI | エディタで手動URL入力 |
| 本文への画像挿入UI | imgix URLを手動コピーしてMarkdownに貼り付け |
| 記事の非公開化（公開→下書き） | 不可（DB直接操作のみ） |

### 予約投稿

- `published_at` を未来日時に設定可能
- 未来日時の記事は公開API（一覧・詳細）で非表示
- 管理API（`fetch_by_id_for_admin`）では時刻フィルタなしで表示
- 予約日時到達後に自動で公開される（クエリの `WHERE published_at <= NOW()` による）
- 予約投稿のUI（日時選択）は未実装。DB直接操作またはAPI直接呼び出しで設定

---

## 8.5 環境制約

### Feature Flag

`ssr` と `hydrate` 機能フラグは相互排他。同時有効化は不可（`cargo-all-features` で強制）。

| フラグ | 用途 |
|--------|------|
| `ssr` | サーバーサイドレンダリング用コード |
| `hydrate` | クライアントサイドハイドレーション用コード |

### features=local Cookie

- `features=local` Cookie が設定されている場合、記事表示がDBソースに切り替わる
- クライアントサイドでのみ切り替え可能（`AdminLayout` のトグル）
- キャッシュ設定がキャッシュ無効化に変更される
